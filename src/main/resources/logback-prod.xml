<?xml version="1.0" encoding="UTF-8"?>
<included>

    <!-- prod 전용 프로퍼티, 추후 prod 설정 시 프로퍼티 채우기-->
    <springProfile name="prod &amp; !docker">
        <property name="LOG_LEVEL" value="${LOG_LEVEL:-INFO}"/>
        <property name="LOG_PATH" value="${LOG_PATH:-/var/log/agenticcp}"/>
        <property name="APP_NAME" value="${APP_NAME:-agenticcp}"/>
        <property name="MAX_FILE_SIZE" value="${MAX_FILE_SIZE:-200MB}"/>
        <property name="MAX_HISTORY" value="${MAX_HISTORY:-14}"/>
        <property name="TOTAL_SIZE_CAP" value="${TOTAL_SIZE_CAP:-3GB}"/>

        <!-- 애플리케이션 일반 로그 (JSON, 압축 롤링) -->
        <appender name="APP_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_PATH}/${APP_NAME}.log</file>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp fieldName="@timestamp" timeZone="Asia/Seoul"/>
                    <logLevel fieldName="level"/>
                    <loggerName fieldName="logger"/>
                    <threadName fieldName="thread"/>
                    <message fieldName="message"/>
                    <mdc fieldName="mdc"/>
                </providers>
            </encoder>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
                <maxHistory>${MAX_HISTORY}</maxHistory>
                <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
                <cleanHistoryOnStart>true</cleanHistoryOnStart>
            </rollingPolicy>
        </appender>

        <!-- 에러 전용 파일 (WARN 이상, 스택트레이스 포함) -->
        <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_PATH}/${APP_NAME}-error.log</file>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp fieldName="@timestamp" timeZone="Asia/Seoul"/>
                    <logLevel fieldName="level"/>
                    <loggerName fieldName="logger"/>
                    <threadName fieldName="thread"/>
                    <message fieldName="message"/>
                    <mdc fieldName="mdc"/>
                    <stackTrace fieldName="stacktrace"/>
                </providers>
            </encoder>
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>WARN</level>
            </filter>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>${LOG_PATH}/${APP_NAME}-error.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
                <maxHistory>${MAX_HISTORY}</maxHistory>
                <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
                <cleanHistoryOnStart>true</cleanHistoryOnStart>
            </rollingPolicy>
        </appender>

        <!-- 비동기 래퍼 -->
        <appender name="ASYNC_APP" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="APP_FILE"/>
            <queueSize>8192</queueSize>
            <discardingThreshold>80</discardingThreshold>
            <neverBlock>true</neverBlock>
        </appender>

        <appender name="ASYNC_ERR" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="ERROR_FILE"/>
            <queueSize>4096</queueSize>
            <neverBlock>true</neverBlock>
        </appender>

        <!-- 레벨/출력 경로 -->
        <root level="${LOG_LEVEL}">
            <appender-ref ref="ASYNC_APP"/>
            <appender-ref ref="ASYNC_ERR"/>
        </root>

        <logger name="org.springframework.security" level="INFO"/>
        <logger name="org.hibernate.SQL" level="WARN"/>
        <logger name="org.hibernate.type.descriptor.sql" level="WARN"/>
    </springProfile>

</included>
