name: Repository Rules
applies_to:
  - src/main/java/**/repository/**.java
  - src/main/java/**/domain/**/repository/**.java
priority: high

---

Goals:
- 데이터 접근을 표준화하고 N+1/성능 이슈를 예방한다
- 테넌트 스코프와 보안 요구를 저장소 레벨에서 일관 적용한다

Directives:
- 메서드명 쿼리 → JPQL @Query → 네이티브 순으로 선택한다
- 모든 조회/수정에 테넌트 조건을 강제한다(필터/스펙/헬퍼)
- DTO/프로젝션으로 응답 형태에 맞춰 직접 투영한다
- Pageable과 정렬 화이트리스트를 준수한다

Allowed:
- EntityGraph/배치 사이즈로 N+1 완화
- 키셋 페이지네이션(대규모 테이블) 적용
- 관리자 전용 교차-테넌트 쿼리(감사 로깅 필수)

Disallowed:
- 문자열 연결 쿼리/파라미터 미바인딩(SQL 인젝션 위험)
- 컬렉션 페치 조인과 페이징의 동시 사용
- 저장소 계층에서 비즈니스 규칙 판단/예외 메시지 구성

Patterns:
- 전용 조회 리포지토리 분리(read-model)
- 카운트 쿼리 분리 및 선택적 캐시
- 인덱스 설계와 실행계획 점검을 PR에 첨부

Anti-patterns:
- 무분별한 네이티브 쿼리 남발로 이식성 저하
- 정렬/필터 컬럼에 대한 인덱스 부재
- 관리자 모드 쿼리 무감사 수행

Checklist:
- [ ] 테넌트 조건 기본 적용 테스트 포함
- [ ] DTO/프로젝션 사용 여부 검토됨
- [ ] N+1 예방 전략 명시됨(EntityGraph/배치/DTO)
- [ ] Pageable/정렬 화이트리스트 준수
- [ ] 인덱스/실행계획 검증 기록 첨부
- [ ] 파라미터 바인딩/민감정보 마스킹 적용
- [ ] 관리자 모드 감사 로깅 존재