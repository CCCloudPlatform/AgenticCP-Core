name: Story Point Tracking

on:
  issues:
    types: [closed, reopened]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC) - ì¼ì¼ ë²¨ë¡œì‹œí‹° ê³„ì‚°
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      period:
        description: 'Tracking period'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - monthly

jobs:
  track-velocity:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate Daily Velocity
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ì–´ì œ ì™„ë£Œëœ UserStory ì¡°íšŒ
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const completedUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:done closed:${yesterdayStr}`
            });
            
            // Story Point ê³„ì‚° (ê°„ë‹¨í•œ ì¶”ì •)
            let totalStoryPoints = 0;
            const userStoryDetails = [];
            
            for (const userStory of completedUserStories.data.items) {
              // UserStory ë³¸ë¬¸ì—ì„œ Story Point ì¶”ì¶œ
              const body = userStory.body || '';
              const spMatch = body.match(/Story Point[:\s]*(\d+)/i);
              const storyPoints = spMatch ? parseInt(spMatch[1]) : 5; // ê¸°ë³¸ê°’ 5 SP
              
              totalStoryPoints += storyPoints;
              userStoryDetails.push({
                number: userStory.number,
                title: userStory.title,
                storyPoints: storyPoints,
                closedAt: userStory.closed_at
              });
            }
            
            console.log(`Daily velocity for ${yesterdayStr}: ${totalStoryPoints} SP`);
            console.log(`Completed UserStories: ${userStoryDetails.length}`);
            
            // ë²¨ë¡œì‹œí‹° ì¶”ì  ì´ìŠˆ ìƒì„± (ì¼ì¼)
            if (totalStoryPoints > 0) {
              const velocityIssue = await github.rest.issues.create({
                owner: owner,
                repo: repo,
                title: `[VELOCITY] ${yesterdayStr} ì¼ì¼ ë²¨ë¡œì‹œí‹°`,
                body: `# ${yesterdayStr} ì¼ì¼ ë²¨ë¡œì‹œí‹°
                
## ğŸ“Š ì™„ë£Œ í†µê³„
- **ì™„ë£Œëœ UserStory**: ${userStoryDetails.length}ê°œ
- **ì™„ë£Œëœ Story Point**: ${totalStoryPoints} SP
- **í‰ê·  UserStoryë‹¹ SP**: ${(totalStoryPoints / userStoryDetails.length).toFixed(1)} SP
                
## ğŸ“‹ ì™„ë£Œëœ UserStory ëª©ë¡
${userStoryDetails.map(us => `- [ ] #${us.number} - ${us.title} (${us.storyPoints} SP)`).join('\n')}
                
## ğŸ“ˆ ë²¨ë¡œì‹œí‹° íŠ¸ë Œë“œ
<!-- ìµœê·¼ 7ì¼ê°„ì˜ ë²¨ë¡œì‹œí‹° íŠ¸ë Œë“œë¥¼ ë¶„ì„í•˜ì„¸ìš” -->
                
## ğŸ¯ ë‹¤ìŒ ëª©í‘œ
<!-- ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš” -->`,
                labels: ['velocity', 'daily', 'done']
              });
              
              console.log(`Created daily velocity issue: #${velocityIssue.data.number}`);
            }

      - name: Calculate Weekly Velocity
        if: github.event_name == 'schedule' && github.event.schedule == '0 9 * * 1' || github.event_name == 'workflow_dispatch' && github.event.inputs.period == 'weekly'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ì§€ë‚œ ì£¼ ì™„ë£Œëœ UserStory ì¡°íšŒ
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            const lastWeekStr = lastWeek.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            const completedUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:done closed:${lastWeekStr}..${todayStr}`
            });
            
            // Story Point ê³„ì‚°
            let totalStoryPoints = 0;
            const userStoryDetails = [];
            
            for (const userStory of completedUserStories.data.items) {
              const body = userStory.body || '';
              const spMatch = body.match(/Story Point[:\s]*(\d+)/i);
              const storyPoints = spMatch ? parseInt(spMatch[1]) : 5;
              
              totalStoryPoints += storyPoints;
              userStoryDetails.push({
                number: userStory.number,
                title: userStory.title,
                storyPoints: storyPoints,
                closedAt: userStory.closed_at
              });
            }
            
            console.log(`Weekly velocity for ${lastWeekStr} to ${todayStr}: ${totalStoryPoints} SP`);
            
            // ì£¼ê°„ ë²¨ë¡œì‹œí‹° ì¶”ì  ì´ìŠˆ ìƒì„±
            const velocityIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[VELOCITY] ${lastWeekStr} ~ ${todayStr} ì£¼ê°„ ë²¨ë¡œì‹œí‹°`,
              body: `# ${lastWeekStr} ~ ${todayStr} ì£¼ê°„ ë²¨ë¡œì‹œí‹°
              
## ğŸ“Š ì™„ë£Œ í†µê³„
- **ì™„ë£Œëœ UserStory**: ${userStoryDetails.length}ê°œ
- **ì™„ë£Œëœ Story Point**: ${totalStoryPoints} SP
- **í‰ê·  UserStoryë‹¹ SP**: ${userStoryDetails.length > 0 ? (totalStoryPoints / userStoryDetails.length).toFixed(1) : 0} SP
- **ì¼í‰ê·  SP**: ${(totalStoryPoints / 7).toFixed(1)} SP
              
## ğŸ“‹ ì™„ë£Œëœ UserStory ëª©ë¡
${userStoryDetails.map(us => `- [ ] #${us.number} - ${us.title} (${us.storyPoints} SP)`).join('\n')}
              
## ğŸ“ˆ ë²¨ë¡œì‹œí‹° ë¶„ì„
### ì´ë²ˆ ì£¼ ì„±ê³¼
- 
- 
- 
              
### ê°œì„ ì 
- 
- 
- 
              
## ğŸ¯ ë‹¤ìŒ ì£¼ ëª©í‘œ
- **ëª©í‘œ Story Point**: ${Math.round(totalStoryPoints * 1.1)} SP (10% ì¦ê°€)
- **ì˜ˆìƒ ì™„ë£Œ UserStory**: ${Math.round(userStoryDetails.length * 1.1)}ê°œ
              
## ğŸ“ ì•¡ì…˜ ì•„ì´í…œ
- [ ] ì•¡ì…˜ 1
- [ ] ì•¡ì…˜ 2
- [ ] ì•¡ì…˜ 3`,
              labels: ['velocity', 'weekly', 'done']
            });
            
            console.log(`Created weekly velocity issue: #${velocityIssue.data.number}`);

      - name: Calculate Monthly Velocity
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.period == 'monthly'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ì§€ë‚œ ë‹¬ ì™„ë£Œëœ UserStory ì¡°íšŒ
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(today.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            const completedUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:done closed:${lastMonthStr}..${todayStr}`
            });
            
            // Story Point ê³„ì‚°
            let totalStoryPoints = 0;
            const userStoryDetails = [];
            
            for (const userStory of completedUserStories.data.items) {
              const body = userStory.body || '';
              const spMatch = body.match(/Story Point[:\s]*(\d+)/i);
              const storyPoints = spMatch ? parseInt(spMatch[1]) : 5;
              
              totalStoryPoints += storyPoints;
              userStoryDetails.push({
                number: userStory.number,
                title: userStory.title,
                storyPoints: storyPoints,
                closedAt: userStory.closed_at
              });
            }
            
            console.log(`Monthly velocity for ${lastMonthStr} to ${todayStr}: ${totalStoryPoints} SP`);
            
            // ì›”ê°„ ë²¨ë¡œì‹œí‹° ì¶”ì  ì´ìŠˆ ìƒì„±
            const velocityIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[VELOCITY] ${lastMonthStr} ~ ${todayStr} ì›”ê°„ ë²¨ë¡œì‹œí‹°`,
              body: `# ${lastMonthStr} ~ ${todayStr} ì›”ê°„ ë²¨ë¡œì‹œí‹°
              
## ğŸ“Š ì™„ë£Œ í†µê³„
- **ì™„ë£Œëœ UserStory**: ${userStoryDetails.length}ê°œ
- **ì™„ë£Œëœ Story Point**: ${totalStoryPoints} SP
- **í‰ê·  UserStoryë‹¹ SP**: ${userStoryDetails.length > 0 ? (totalStoryPoints / userStoryDetails.length).toFixed(1) : 0} SP
- **ì¼í‰ê·  SP**: ${(totalStoryPoints / 30).toFixed(1)} SP
              
## ğŸ“‹ ì™„ë£Œëœ UserStory ëª©ë¡
${userStoryDetails.map(us => `- [ ] #${us.number} - ${us.title} (${us.storyPoints} SP)`).join('\n')}
              
## ğŸ“ˆ ë²¨ë¡œì‹œí‹° íŠ¸ë Œë“œ ë¶„ì„
### ì´ë²ˆ ë‹¬ ì„±ê³¼
- 
- 
- 
              
### ê°œì„ ì 
- 
- 
- 
              
## ğŸ¯ ë‹¤ìŒ ë‹¬ ëª©í‘œ
- **ëª©í‘œ Story Point**: ${Math.round(totalStoryPoints * 1.2)} SP (20% ì¦ê°€)
- **ì˜ˆìƒ ì™„ë£Œ UserStory**: ${Math.round(userStoryDetails.length * 1.2)}ê°œ
              
## ğŸ“ ì›”ê°„ ì•¡ì…˜ ì•„ì´í…œ
- [ ] ì•¡ì…˜ 1
- [ ] ì•¡ì…˜ 2
- [ ] ì•¡ì…˜ 3
              
## ğŸ† íŒ€ ì„±ê³¼
<!-- íŒ€ì›ë³„ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ì„¸ìš” -->`,
              labels: ['velocity', 'monthly', 'done']
            });
            
            console.log(`Created monthly velocity issue: #${velocityIssue.data.number}`);

      - name: Update Burndown Chart
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ì˜ ì§„í–‰ ìƒí™© ê³„ì‚°
            const startDate = new Date('2024-01-01');
            const currentDate = new Date();
            const weeksSinceStart = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            const sprintNumber = weeksSinceStart + 1;
            
            // ìŠ¤í”„ë¦°íŠ¸ ì‹œì‘ì¼ ê³„ì‚°
            const sprintStartDate = new Date(startDate);
            sprintStartDate.setDate(startDate.getDate() + (sprintNumber - 1) * 7);
            const sprintStartStr = sprintStartDate.toISOString().split('T')[0];
            
            // ìŠ¤í”„ë¦°íŠ¸ ì¢…ë£Œì¼ ê³„ì‚°
            const sprintEndDate = new Date(sprintStartDate);
            sprintEndDate.setDate(sprintStartDate.getDate() + 7);
            const sprintEndStr = sprintEndDate.toISOString().split('T')[0];
            
            // ìŠ¤í”„ë¦°íŠ¸ ê¸°ê°„ ë‚´ ì™„ë£Œëœ UserStory ì¡°íšŒ
            const completedUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:done closed:${sprintStartStr}..${sprintEndStr}`
            });
            
            // ì™„ë£Œëœ Story Point ê³„ì‚°
            let completedStoryPoints = 0;
            for (const userStory of completedUserStories.data.items) {
              const body = userStory.body || '';
              const spMatch = body.match(/Story Point[:\s]*(\d+)/i);
              const storyPoints = spMatch ? parseInt(spMatch[1]) : 5;
              completedStoryPoints += storyPoints;
            }
            
            // ìŠ¤í”„ë¦°íŠ¸ ëª©í‘œ Story Point (ê¸°ë³¸ê°’ 40 SP)
            const targetStoryPoints = 40;
            const remainingStoryPoints = Math.max(0, targetStoryPoints - completedStoryPoints);
            
            // ë°±ë¡œê·¸ ë²„ë‹ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const burndownIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[BURNDOWN] Sprint ${sprintNumber} ë°±ë¡œê·¸ ë²„ë‹ ì°¨íŠ¸`,
              body: `# Sprint ${sprintNumber} ë°±ë¡œê·¸ ë²„ë‹ ì°¨íŠ¸
              
## ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©
- **ëª©í‘œ Story Point**: ${targetStoryPoints} SP
- **ì™„ë£Œëœ Story Point**: ${completedStoryPoints} SP
- **ë‚¨ì€ Story Point**: ${remainingStoryPoints} SP
- **ì™„ë£Œìœ¨**: ${((completedStoryPoints / targetStoryPoints) * 100).toFixed(1)}%
              
## ğŸ“ˆ ë°±ë¡œê·¸ ë²„ë‹ ì°¨íŠ¸
\`\`\`
ëª©í‘œ: ${targetStoryPoints} SP
ì™„ë£Œ: ${completedStoryPoints} SP
ë‚¨ì€: ${remainingStoryPoints} SP
              
ì§„í–‰ë¥ : ${'â–ˆ'.repeat(Math.floor((completedStoryPoints / targetStoryPoints) * 20))}${'â–‘'.repeat(20 - Math.floor((completedStoryPoints / targetStoryPoints) * 20))} ${((completedStoryPoints / targetStoryPoints) * 100).toFixed(1)}%
\`\`\`
              
## ğŸ“‹ ì™„ë£Œëœ UserStory
${completedUserStories.data.items.map(us => `- [x] #${us.number} - ${us.title}`).join('\n')}
              
## ğŸ¯ ë‹¤ìŒ ëª©í‘œ
<!-- ë‹¤ìŒì— ì™„ë£Œí•  UserStoryë¥¼ ë‚˜ì—´í•˜ì„¸ìš” -->
- [ ] UserStory 1
- [ ] UserStory 2
- [ ] UserStory 3
              
## ğŸ“ ìŠ¤í”„ë¦°íŠ¸ ë…¸íŠ¸
<!-- ìŠ¤í”„ë¦°íŠ¸ ì§„í–‰ ìƒí™©ì— ëŒ€í•œ íŠ¹ì´ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš” -->`,
              labels: ['burndown', 'sprint', 'done']
            });
            
            console.log(`Created burndown chart issue: #${burndownIssue.data.number}`);
