name: Sprint Automation

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC) - ìŠ¤í”„ë¦°íŠ¸ ì‹œì‘
    - cron: '0 0 * * 1'
    # ë§¤ì£¼ ê¸ˆìš”ì¼ ì˜¤í›„ 6ì‹œ (UTC) - ìŠ¤í”„ë¦°íŠ¸ ë¦¬ë·°
    - cron: '0 18 * * 5'
  workflow_dispatch:
    inputs:
      action:
        description: 'Sprint action to perform'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - review
          - close

jobs:
  sprint-start:
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * 1' || github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start'
    runs-on: ubuntu-latest
    steps:
      - name: Start New Sprint
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ ë²ˆí˜¸ ê³„ì‚° (2024ë…„ 1ì›” 1ì¼ ê¸°ì¤€)
            const startDate = new Date('2024-01-01');
            const currentDate = new Date();
            const weeksSinceStart = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            const sprintNumber = weeksSinceStart + 1;
            
            console.log(`Starting Sprint ${sprintNumber}`);
            
            // ìŠ¤í”„ë¦°íŠ¸ ì‹œì‘ ì´ìŠˆ ìƒì„±
            const sprintIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[SPRINT] Sprint ${sprintNumber} ì‹œì‘`,
              body: `# Sprint ${sprintNumber} ì‹œì‘
              
## ğŸ“… ìŠ¤í”„ë¦°íŠ¸ ì •ë³´
- **ìŠ¤í”„ë¦°íŠ¸ ë²ˆí˜¸**: ${sprintNumber}
- **ì‹œì‘ì¼**: ${currentDate.toISOString().split('T')[0]}
- **ì¢…ë£Œì¼**: ${new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}
              
## ğŸ¯ ìŠ¤í”„ë¦°íŠ¸ ëª©í‘œ
- [ ] ëª©í‘œ 1
- [ ] ëª©í‘œ 2
- [ ] ëª©í‘œ 3
              
## ğŸ“‹ í¬í•¨ëœ UserStory
<!-- ì´ ìŠ¤í”„ë¦°íŠ¸ì— í¬í•¨ëœ UserStoryë“¤ì„ ë‚˜ì—´í•˜ì„¸ìš” -->
              
## ğŸ“Š ì¶”ì • Story Point
- **ì´ Story Point**: 0 SP
- **íŒ€ ìš©ëŸ‰**: 40 SP
- **ì—¬ìœ ë¶„**: 40 SP
              
## ğŸ‘¥ íŒ€ì›ë³„ í• ë‹¹
- **ê°œë°œì 1**: 0 SP
- **ê°œë°œì 2**: 0 SP
- **ê°œë°œì 3**: 0 SP
              
## ğŸ“ ìŠ¤í”„ë¦°íŠ¸ ë…¸íŠ¸
<!-- ìŠ¤í”„ë¦°íŠ¸ ê´€ë ¨ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš” -->`,
              labels: ['sprint', 'in-progress']
            });
            
            console.log(`Created Sprint ${sprintNumber} issue: #${sprintIssue.data.number}`);
            
            // ready-for-work ìƒíƒœì˜ UserStoryë“¤ì„ in-progressë¡œ ë³€ê²½
            const readyUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:ready-for-work`
            });
            
            for (const userStory of readyUserStories.data.items) {
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: userStory.number,
                labels: ['in-progress']
              });
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: userStory.number,
                name: 'ready-for-work'
              }).catch(() => {});
              
              console.log(`Moved UserStory #${userStory.number} to in-progress`);
            }

  sprint-review:
    if: github.event_name == 'schedule' && github.event.schedule == '0 18 * * 5' || github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'review'
    runs-on: ubuntu-latest
    steps:
      - name: Sprint Review
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ ë²ˆí˜¸ ê³„ì‚°
            const startDate = new Date('2024-01-01');
            const currentDate = new Date();
            const weeksSinceStart = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            const sprintNumber = weeksSinceStart;
            
            console.log(`Reviewing Sprint ${sprintNumber}`);
            
            // ì™„ë£Œëœ UserStory í†µê³„
            const completedUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:done`
            });
            
            // ì§„í–‰ ì¤‘ì¸ UserStory í†µê³„
            const inProgressUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:in-progress`
            });
            
            // ì™„ë£Œëœ Feature í†µê³„
            const completedFeatures = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:feature label:done`
            });
            
            // ì™„ë£Œëœ Task í†µê³„
            const completedTasks = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:task label:done`
            });
            
            // Story Point ê³„ì‚° (ê°„ë‹¨í•œ ì¶”ì •)
            const estimatedStoryPoints = completedUserStories.data.items.length * 5; // í‰ê·  5 SPë¡œ ì¶”ì •
            
            // ìŠ¤í”„ë¦°íŠ¸ ë¦¬ë·° ì´ìŠˆ ìƒì„±
            const reviewIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[SPRINT-REVIEW] Sprint ${sprintNumber} ë¦¬ë·°`,
              body: `# Sprint ${sprintNumber} ë¦¬ë·°
              
## ğŸ“Š ì™„ë£Œ í†µê³„
- **ì™„ë£Œëœ UserStory**: ${completedUserStories.data.items.length}ê°œ
- **ì™„ë£Œëœ Feature**: ${completedFeatures.data.items.length}ê°œ
- **ì™„ë£Œëœ Task**: ${completedTasks.data.items.length}ê°œ
- **ì¶”ì • ì™„ë£Œ Story Point**: ${estimatedStoryPoints} SP
              
## ğŸ¯ ë‹¬ì„±í•œ ëª©í‘œ
- [ ] ëª©í‘œ 1
- [ ] ëª©í‘œ 2
- [ ] ëª©í‘œ 3
              
## ğŸ“ˆ ì„±ê³¼ ë¶„ì„
### ì˜í•œ ì 
- 
- 
- 
              
### ê°œì„ í•  ì 
- 
- 
- 
              
### ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ì—ì„œ ì‹œë„í•  ì 
- 
- 
- 
              
## ğŸ”„ ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ ê³„íš
### ìš°ì„ ìˆœìœ„ ë†’ì€ UserStory
- [ ] UserStory 1
- [ ] UserStory 2
- [ ] UserStory 3
              
### ì˜ˆìƒ Story Point
- **ëª©í‘œ Story Point**: 40 SP
- **ì˜ˆìƒ ì™„ë£Œ UserStory**: 8ê°œ
              
## ğŸ“ ì•¡ì…˜ ì•„ì´í…œ
- [ ] ì•¡ì…˜ 1
- [ ] ì•¡ì…˜ 2
- [ ] ì•¡ì…˜ 3
              
## ğŸ‘¥ íŒ€ í”¼ë“œë°±
<!-- íŒ€ì›ë“¤ì˜ í”¼ë“œë°±ì„ ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš” -->`,
              labels: ['sprint-review', 'done']
            });
            
            console.log(`Created Sprint ${sprintNumber} review issue: #${reviewIssue.data.number}`);

  sprint-close:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'close'
    runs-on: ubuntu-latest
    steps:
      - name: Close Sprint
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ ë²ˆí˜¸ ê³„ì‚°
            const startDate = new Date('2024-01-01');
            const currentDate = new Date();
            const weeksSinceStart = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            const sprintNumber = weeksSinceStart;
            
            console.log(`Closing Sprint ${sprintNumber}`);
            
            // ì§„í–‰ ì¤‘ì¸ UserStoryë“¤ì„ ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ë¡œ ì´ë™
            const inProgressUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story label:in-progress`
            });
            
            for (const userStory of inProgressUserStories.data.items) {
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: userStory.number,
                labels: ['ready-for-work']
              });
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: userStory.number,
                name: 'in-progress'
              }).catch(() => {});
              
              console.log(`Moved UserStory #${userStory.number} to ready-for-work for next sprint`);
            }
            
            // ìŠ¤í”„ë¦°íŠ¸ ì¢…ë£Œ ì´ìŠˆ ìƒì„±
            const closeIssue = await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: `[SPRINT-CLOSE] Sprint ${sprintNumber} ì¢…ë£Œ`,
              body: `# Sprint ${sprintNumber} ì¢…ë£Œ
              
## ğŸ“Š ìµœì¢… í†µê³„
- **ì™„ë£Œëœ UserStory**: ${completedUserStories.data.items.length}ê°œ
- **ì™„ë£Œëœ Feature**: ${completedFeatures.data.items.length}ê°œ
- **ì™„ë£Œëœ Task**: ${completedTasks.data.items.length}ê°œ
              
## ğŸ”„ ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ ì¤€ë¹„
- ë¯¸ì™„ë£Œ UserStoryë“¤ì„ ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ë¡œ ì´ë™
- ìƒˆë¡œìš´ UserStory ìš°ì„ ìˆœìœ„ ì¡°ì •
- íŒ€ ë²¨ë¡œì‹œí‹° ë¶„ì„ ì™„ë£Œ
              
## ğŸ“ ìŠ¤í”„ë¦°íŠ¸ íšŒê³ 
<!-- ìŠ¤í”„ë¦°íŠ¸ íšŒê³  ë‚´ìš©ì„ ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš” -->`,
              labels: ['sprint-close', 'done']
            });
            
            console.log(`Created Sprint ${sprintNumber} close issue: #${closeIssue.data.number}`);
