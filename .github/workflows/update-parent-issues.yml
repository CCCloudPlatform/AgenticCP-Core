name: Update Parent Issues

on:
  issues:
    types: [closed, reopened]

jobs:
  update-parent:
    runs-on: ubuntu-latest
    steps:
      - name: Update Feature when all Tasks are done
        if: contains(github.event.issue.labels.*.name, 'task')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            const issueNumber = issue.number;
            const owner = issue.owner;
            const repo = issue.repo;
            
            console.log(`Processing Task issue #${issueNumber}`);
            
            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ìƒìœ„ Feature ì°¾ê¸°
            const issueBody = context.payload.issue.body;
            const featureMatch = issueBody.match(/Feature:\s*#(\d+)/i);
            
            if (!featureMatch) {
              console.log(`No parent Feature found in Task issue #${issueNumber}`);
              return;
            }
            
            const parentFeatureNumber = parseInt(featureMatch[1]);
            console.log(`Found parent Feature: #${parentFeatureNumber}`);
            
            // Feature ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const parentIssue = await github.rest.issues.get({
              owner: owner,
              repo: repo,
              issue_number: parentFeatureNumber
            });
            
            if (!parentIssue.data) {
              console.log(`Parent Feature #${parentFeatureNumber} not found`);
              return;
            }
            
            // Featureì˜ ëª¨ë“  Task ì°¾ê¸°
            const allTasks = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:task in:body "Feature: #${parentFeatureNumber}"`
            });
            
            console.log(`Found ${allTasks.data.items.length} tasks for Feature #${parentFeatureNumber}`);
            
            // ì™„ë£Œëœ Task ìˆ˜ ê³„ì‚°
            const completedTasks = allTasks.data.items.filter(task => 
              task.state === 'closed' && 
              task.labels.some(label => label.name === 'done')
            );
            
            console.log(`Completed tasks: ${completedTasks.length}/${allTasks.data.items.length}`);
            
            // ëª¨ë“  Taskê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (completedTasks.length === allTasks.data.items.length && allTasks.data.items.length > 0) {
              // Featureë¥¼ doneìœ¼ë¡œ ë³€ê²½
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: parentFeatureNumber,
                labels: ['done']
              });
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentFeatureNumber,
                name: 'in-progress'
              }).catch(() => {});
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentFeatureNumber,
                name: 'ready-for-work'
              }).catch(() => {});
              
              console.log(`Feature #${parentFeatureNumber} marked as done - all tasks completed`);
              
              // Feature ì™„ë£Œ ì•Œë¦¼ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: parentFeatureNumber,
                body: `ğŸ‰ **Feature ì™„ë£Œ!**\n\nëª¨ë“  Taskê°€ ì™„ë£Œë˜ì–´ ì´ Featureê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- ì™„ë£Œëœ Task: ${completedTasks.length}ê°œ\n- ì´ Task: ${allTasks.data.items.length}ê°œ`
              });
            } else {
              console.log(`Feature #${parentFeatureNumber} not ready for completion yet`);
            }

      - name: Update UserStory when all Features are done
        if: contains(github.event.issue.labels.*.name, 'feature')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            const issueNumber = issue.number;
            const owner = issue.owner;
            const repo = issue.repo;
            
            console.log(`Processing Feature issue #${issueNumber}`);
            
            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ìƒìœ„ UserStory ì°¾ê¸°
            const issueBody = context.payload.issue.body;
            const userStoryMatch = issueBody.match(/UserStory:\s*#(\d+)/i);
            
            if (!userStoryMatch) {
              console.log(`No parent UserStory found in Feature issue #${issueNumber}`);
              return;
            }
            
            const parentUserStoryNumber = parseInt(userStoryMatch[1]);
            console.log(`Found parent UserStory: #${parentUserStoryNumber}`);
            
            // UserStory ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const parentIssue = await github.rest.issues.get({
              owner: owner,
              repo: repo,
              issue_number: parentUserStoryNumber
            });
            
            if (!parentIssue.data) {
              console.log(`Parent UserStory #${parentUserStoryNumber} not found`);
              return;
            }
            
            // UserStoryì˜ ëª¨ë“  Feature ì°¾ê¸°
            const allFeatures = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:feature in:body "UserStory: #${parentUserStoryNumber}"`
            });
            
            console.log(`Found ${allFeatures.data.items.length} features for UserStory #${parentUserStoryNumber}`);
            
            // ì™„ë£Œëœ Feature ìˆ˜ ê³„ì‚°
            const completedFeatures = allFeatures.data.items.filter(feature => 
              feature.state === 'closed' && 
              feature.labels.some(label => label.name === 'done')
            );
            
            console.log(`Completed features: ${completedFeatures.length}/${allFeatures.data.items.length}`);
            
            // ëª¨ë“  Featureê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (completedFeatures.length === allFeatures.data.items.length && allFeatures.data.items.length > 0) {
              // UserStoryë¥¼ doneìœ¼ë¡œ ë³€ê²½
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: parentUserStoryNumber,
                labels: ['done']
              });
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentUserStoryNumber,
                name: 'in-progress'
              }).catch(() => {});
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentUserStoryNumber,
                name: 'ready-for-work'
              }).catch(() => {});
              
              console.log(`UserStory #${parentUserStoryNumber} marked as done - all features completed`);
              
              // UserStory ì™„ë£Œ ì•Œë¦¼ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: parentUserStoryNumber,
                body: `ğŸ‰ **UserStory ì™„ë£Œ!**\n\nëª¨ë“  Featureê°€ ì™„ë£Œë˜ì–´ ì´ UserStoryê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- ì™„ë£Œëœ Feature: ${completedFeatures.length}ê°œ\n- ì´ Feature: ${allFeatures.data.items.length}ê°œ`
              });
            } else {
              console.log(`UserStory #${parentUserStoryNumber} not ready for completion yet`);
            }

      - name: Update Epic when all UserStories are done
        if: contains(github.event.issue.labels.*.name, 'user-story')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            const issueNumber = issue.number;
            const owner = issue.owner;
            const repo = issue.repo;
            
            console.log(`Processing UserStory issue #${issueNumber}`);
            
            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ìƒìœ„ Epic ì°¾ê¸°
            const issueBody = context.payload.issue.body;
            const epicMatch = issueBody.match(/Epic:\s*#(\d+)/i);
            
            if (!epicMatch) {
              console.log(`No parent Epic found in UserStory issue #${issueNumber}`);
              return;
            }
            
            const parentEpicNumber = parseInt(epicMatch[1]);
            console.log(`Found parent Epic: #${parentEpicNumber}`);
            
            // Epic ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const parentIssue = await github.rest.issues.get({
              owner: owner,
              repo: repo,
              issue_number: parentEpicNumber
            });
            
            if (!parentIssue.data) {
              console.log(`Parent Epic #${parentEpicNumber} not found`);
              return;
            }
            
            // Epicì˜ ëª¨ë“  UserStory ì°¾ê¸°
            const allUserStories = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue label:user-story in:body "Epic: #${parentEpicNumber}"`
            });
            
            console.log(`Found ${allUserStories.data.items.length} user stories for Epic #${parentEpicNumber}`);
            
            // ì™„ë£Œëœ UserStory ìˆ˜ ê³„ì‚°
            const completedUserStories = allUserStories.data.items.filter(userStory => 
              userStory.state === 'closed' && 
              userStory.labels.some(label => label.name === 'done')
            );
            
            console.log(`Completed user stories: ${completedUserStories.length}/${allUserStories.data.items.length}`);
            
            // ëª¨ë“  UserStoryê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (completedUserStories.length === allUserStories.data.items.length && allUserStories.data.items.length > 0) {
              // Epicì„ doneìœ¼ë¡œ ë³€ê²½
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: parentEpicNumber,
                labels: ['done']
              });
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentEpicNumber,
                name: 'in-progress'
              }).catch(() => {});
              
              await github.rest.issues.removeLabel({
                owner: owner,
                repo: repo,
                issue_number: parentEpicNumber,
                name: 'ready-for-work'
              }).catch(() => {});
              
              console.log(`Epic #${parentEpicNumber} marked as done - all user stories completed`);
              
              // Epic ì™„ë£Œ ì•Œë¦¼ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: parentEpicNumber,
                body: `ğŸ‰ **Epic ì™„ë£Œ!**\n\nëª¨ë“  UserStoryê°€ ì™„ë£Œë˜ì–´ ì´ Epicì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- ì™„ë£Œëœ UserStory: ${completedUserStories.length}ê°œ\n- ì´ UserStory: ${allUserStories.data.items.length}ê°œ`
              });
            } else {
              console.log(`Epic #${parentEpicNumber} not ready for completion yet`);
            }
